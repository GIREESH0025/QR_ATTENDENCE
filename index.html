<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Attendance System (IndexedDB)</title>
<style>
/* --- CSS Variables for Easy Theming --- */
:root {
    --primary-color: #007bff; /* Blue */
    --secondary-color: #28a745; /* Green for success */
    --info-color: #17a2b8; /* Teal for info/exports */
    --danger-color: #dc3545; /* Red for errors */
    --background-light: #f4f7f9;
    --background-white: #ffffff;
    --text-color-dark: #2c3e50;
    --text-color-light: #f8f9fa;
    --border-color: #ced4da;
    --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.12);
}

/* --- Base & Typography --- */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: var(--background-light);
    color: var(--text-color-dark);
    line-height: 1.6;
}

h1 {
    text-align: center;
    color: var(--primary-color);
    margin: 30px 0 10px;
    font-size: 2.5rem;
    font-weight: 700;
}

h2 {
    text-align: center;
    color: var(--text-color-dark);
    margin: 10px 0 20px;
    font-size: 1.8rem;
    font-weight: 600;
    border-bottom: none;
    padding-bottom: 0;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

h3 {
    margin-top: 30px;
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--primary-color);
    text-align: center;
}

/* --- Navigation --- */
nav {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    margin: 20px 0 40px;
    padding: 0 10px;
}

nav button {
    padding: 12px 22px;
    border: none;
    border-radius: 6px;
    background: var(--primary-color);
    color: var(--text-color-light);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    margin: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

nav button:hover {
    background: #0056b3;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

nav button.active-nav {
    background: #004c99;
    box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
    transform: translateY(0);
}

/* --- Tab Content: The Main Card Container --- */
.tab {
    display: none;
    max-width: 800px;
    margin: 0 auto 50px;
    padding: 40px;
    background: var(--background-white);
    border-radius: 12px;
    box-shadow: var(--shadow-light);
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.active {
    display: block;
}

/* --- Form Elements & Inputs --- */
label {
    display: block;
    margin: 20px 0 8px;
    font-weight: 600;
    color: #495057;
    font-size: 1rem;
}

input[type="text"],
input[type="number"],
input[type="file"],
select {
    width: 100%;
    max-width: 500px;
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    margin-bottom: 5px;
    transition: border-color 0.3s, box-shadow 0.3s;
    font-size: 1rem;
    box-sizing: border-box;
    background-color: #fff;
}

input[type="text"]:focus,
input[type="number"]:focus,
select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    outline: none;
}

/* --- Buttons (General) --- */
.tab button, .tab a.button {
    padding: 12px 25px;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    margin: 25px 5px 15px 0;
    display: inline-block;
}

/* --- Specific Section Styles --- */
#qrCanvas {
    display: block;
    margin: 25px auto;
    border: 5px solid var(--primary-color);
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    max-width: 90%;
    height: auto;
}

#genStatus {
    text-align: center;
    margin-top: 15px;
    font-size: 0.95rem;
    font-weight: 500;
}

#preview {
    display: block;
    margin: 0 auto 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    max-width: 100%;
    height: auto;
    background-color: #eee;
}

#scanControls {
    text-align: center;
    margin-bottom: 20px;
}

#scanResult, #manualResult {
    text-align: center;
    font-weight: 700;
    margin: 20px 0;
    font-size: 1.1rem;
    padding: 10px;
    border-radius: 8px;
}

#scanResult span[style*="--danger-color"], #manualResult span[style*="--danger-color"] {
    color: var(--danger-color);
    background: rgba(220, 53, 69, 0.1);
    display: block;
    padding: 10px;
    border-radius: 8px;
}

#scanResult span[style*="--secondary-color"], #manualResult span[style*="--secondary-color"] {
    color: var(--secondary-color);
    background: rgba(40, 167, 69, 0.1);
    display: block;
    padding: 10px;
    border-radius: 8px;
}

/* --- History Lists --- */
#scanHistory, #manualHistory, #stuList, #attList {
    max-width: 600px;
    margin: 15px auto;
    list-style: none;
    padding: 0;
}

#scanHistory li, #manualHistory li, #stuList li, #attList li {
    background: var(--background-light);
    margin: 8px 0;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 0.95rem;
    border-left: 5px solid var(--primary-color);
    transition: background 0.3s;
    word-break: break-word;
}

/* --- Tables --- */
table {
    width: 100%;
    margin: 20px auto 30px;
    border-collapse: separate;
    border-spacing: 0;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    overflow: hidden;
}

th, td {
    padding: 12px 15px;
    text-align: center;
    border-bottom: 1px solid #e9ecef;
}

th {
    background: var(--primary-color);
    color: var(--text-color-light);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9rem;
}

tbody tr:nth-child(even) {
    background: #f8fafd;
}

/* --- Responsiveness --- */
@media (max-width: 768px) {
    h1 { font-size: 2rem; }
    nav { flex-direction: row; gap: 5px; }
    nav button { flex-grow: 1; max-width: 48%; }
    table { display: block; overflow-x: auto; white-space: nowrap; }
}
</style>
</head>
<body>
<h1>QR Attendance System (IndexedDB)</h1>

<nav>
    <button data-tab="gen">Generate QR</button>
    <button data-tab="scan">Scan QR</button>
    <button data-tab="manual">Manual Attendance</button>
    <button data-tab="students">Students</button>
    <button data-tab="attendance">Attendance</button>
    <button data-tab="reports">Reports</button>
</nav>

<div id="gen" class="tab active">
    <h2>Generate QR Code</h2>
    <label for="genRoll">Roll:</label>
    <input id="genRoll" type="text" placeholder="Student Roll Number"><br>
    <label for="genName">Name:</label>
    <input id="genName" type="text" placeholder="Student Name"><br>
    <label for="genClass">Class:</label>
    <input id="genClass" type="text" placeholder="e.g., 10A, BTech CS"><br>
    <button id="genBtn">Generate QR Code</button>
    <canvas id="qrCanvas" width="450" height="450"></canvas><br>
    <a id="downloadBtn" style="display:none" class="button">Download QR</a>
    <div id="genStatus"></div>
</div>

<div id="scan" class="tab">
    <h2>Scan QR Code</h2>
    <video id="preview" width="300" height="200"></video><br>
    <div id="scanControls">
        <button id="startScan">Start Scan</button>
        <button id="stopScan">Stop Scan</button>
    </div>
    <div id="scanResult"></div>
    <h3>Attendance History for Scanned Student</h3>
    <ul id="scanHistory"></ul>
</div>

<div id="manual" class="tab">
    <h2>Manual Attendance</h2>
    <label for="manualRoll">Enter Roll Number:</label>
    <input type="text" id="manualRoll" placeholder="Roll Number"><br>
    <button id="markManual">Mark Attendance</button>
    <div id="manualResult"></div>
    <h3>Manual Attendance History</h3>
    <ul id="manualHistory"></ul>
</div>

<div id="students" class="tab">
    <h2>Students List & Management</h2>
    <label for="importCSV">Import Students from CSV:</label>
    <input type="file" id="importCSV" accept=".csv">
    <button id="exportStudents">Export Students CSV</button>
    <button id="backupDB">Backup Database (JSON)</button>
    <h3>Current Students</h3>
    <ul id="stuList"></ul>
</div>

<div id="attendance" class="tab">
    <h2>Raw Attendance Records</h2>
    <button id="exportRawAttendance">Export Raw Attendance CSV</button>
    <button id="exportStudentReport">Export Student Report CSV</button>
    <button id="exportClassReport">Export Class Report CSV</button>
    <h3>All Attendance Entries</h3>
    <ul id="attList"></ul>
</div>

<div id="reports" class="tab">
    <h2>Monthly Attendance Report Generation</h2>
    <label for="monthSelect">Select Month:</label>
    <select id="monthSelect"></select>

    <label for="workingDays">Enter Working Days for Percentage Calculation:</label>
    <input type="number" id="workingDays" placeholder="e.g. 22" value="22">
    <button id="genReport">Generate Report</button>

    <h3>Student-wise Report</h3>
    <table id="reportTable">
        <thead>
        <tr>
            <th>Roll</th><th>Name</th><th>Class</th><th>Month</th>
            <th>Days Attended</th><th>Total Days</th><th>%</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3>Class-wise Report</h3>
    <table id="classReportTable">
        <thead>
        <tr>
            <th>Class</th><th>Month</th><th>Total Students</th>
            <th>Total Days</th><th>Total Attendance</th><th>%</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // ---------- IndexedDB Setup ----------
    const DB_NAME = 'AttendanceDB';
    const DB_VERSION = 1;
    const STORE_STUDENTS = 'students';
    const STORE_ATTENDANCE = 'attendance';
    let dbPromise;

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_STUDENTS)) {
                    db.createObjectStore(STORE_STUDENTS, { keyPath: 'roll' });
                }
                if (!db.objectStoreNames.contains(STORE_ATTENDANCE)) {
                    const attendanceStore = db.createObjectStore(STORE_ATTENDANCE, { keyPath: 'id', autoIncrement: true });
                    attendanceStore.createIndex('roll_date', ['roll', 'date'], { unique: false });
                }
            };
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
        });
    }

    async function performDBOperation(storeName, mode, operation) {
        const db = await dbPromise;
        const transaction = db.transaction([storeName], mode);
        const store = transaction.objectStore(storeName);
        return new Promise((resolve, reject) => {
            const request = operation(store);
            request.onsuccess = () => resolve(request.result);
            request.onerror = (e) => reject(e.target.error);
        });
    }

    const getAllData = (storeName) => performDBOperation(storeName, 'readonly', store => store.getAll());
    const getDataByKey = (storeName, key) => performDBOperation(storeName, 'readonly', store => store.get(key));
    const putData = (storeName, data) => performDBOperation(storeName, 'readwrite', store => store.put(data));
    const loadStudents = () => getAllData(STORE_STUDENTS);
    const saveStudent = (student) => putData(STORE_STUDENTS, student);
    const loadAttendance = () => getAllData(STORE_ATTENDANCE);
    const saveAttendanceRecord = (record) => putData(STORE_ATTENDANCE, record);
    
    const saveWorkingDays = (val) => localStorage.setItem('workingDays', val);
    const loadWorkingDays = () => parseInt(localStorage.getItem('workingDays') || '22');
    
    dbPromise = openDB();

    // ---------- Tabs ----------
    const tabs = document.querySelectorAll('.tab');
    const navButtons = document.querySelectorAll('nav button');
    navButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
            tabs.forEach(t => t.classList.remove('active'));
            navButtons.forEach(b => b.classList.remove('active-nav'));
            
            document.getElementById(btn.dataset.tab).classList.add('active');
            btn.classList.add('active-nav');

            if (btn.dataset.tab === 'students') await renderStudents();
            if (btn.dataset.tab === 'attendance') await renderAttendance();
            if (btn.dataset.tab === 'reports') {
                document.getElementById('workingDays').value = loadWorkingDays();
                await populateMonthSelector();
                await handleGenerateReport();
            }
        });
    });

    // ---------- Generate QR ----------
    const genBtn = document.getElementById('genBtn');
    genBtn.addEventListener('click', async () => {
        const roll = document.getElementById('genRoll').value.trim();
        const name = document.getElementById('genName').value.trim() || "Unknown";
        const cls = document.getElementById('genClass').value.trim() || "N/A";
        const genStatus = document.getElementById('genStatus');

        if (!roll) {
            alert('Please enter a Roll Number.');
            return;
        }

        const newStudentData = { roll, name, class: cls };
        let statusMessage = '';

        try {
            const existingStudent = await getDataByKey(STORE_STUDENTS, roll);
            const needsUpdate = !existingStudent || existingStudent.name !== name || existingStudent.class !== cls;
            
            if (needsUpdate) {
                await saveStudent(newStudentData);
                statusMessage = existingStudent ? `Student info updated for ${roll}.` : `New student ${roll} added.`;
            } else {
                statusMessage = `QR for ${roll} is already up-to-date.`;
            }

            const payload = `ATT|${roll}|${name}|${cls}`;
            new QRious({
                element: document.getElementById('qrCanvas'),
                value: payload,
                size: 450,
                level: 'H'
            });

            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.href = document.getElementById('qrCanvas').toDataURL('image/png');
            downloadBtn.download = `qr_${roll}.png`;
            downloadBtn.style.display = 'inline-block';
            genStatus.textContent = statusMessage;
        } catch (e) {
            console.error(e);
            genStatus.textContent = `Error saving student or generating QR: ${e.message}`;
        }
    });

    // ---------- Scanner ----------
    let codeReader = null;
    let activeStream = null;
    let lastScanned = "";

    document.getElementById('startScan').addEventListener('click', async () => {
        codeReader = new ZXing.BrowserQRCodeReader();
        const scanResultDiv = document.getElementById('scanResult');
        const videoElement = document.getElementById('preview');
        scanResultDiv.textContent = "Starting camera...";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            activeStream = stream;
            videoElement.srcObject = stream;
            scanResultDiv.textContent = "Scanning...";
            codeReader.decodeFromStream(stream, videoElement, (result, err) => {
                if (result && result.getText() !== lastScanned) {
                    lastScanned = result.getText();
                    handleScan(lastScanned, 'scanResult');
                    setTimeout(() => { lastScanned = ""; }, 3000);
                }
            });
        } catch (e) {
            console.error("Camera error:", e);
            scanResultDiv.textContent = "Could not access camera. Please grant permission.";
        }
    });

    document.getElementById('stopScan').addEventListener('click', () => {
        if (codeReader) codeReader.reset();
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            activeStream = null;
        }
        document.getElementById('scanResult').textContent = "Scan stopped.";
    });

    // ---------- Handle Scan / Manual Entry ----------
    async function handleScan(payload, resultDivId) {
        const resultDiv = document.getElementById(resultDivId);
        const parts = (payload || '').split('|').map(p => p.trim());
        const roll = (parts.length >= 2 && parts[0].toUpperCase() === 'ATT') ? parts[1] : parts[0];
        const today = new Date().toISOString().slice(0, 10);

        if (!roll) {
            resultDiv.innerHTML = `<span style="color:var(--danger-color)">❌ Invalid QR/Roll Data.</span>`;
            return;
        }

        try {
            const student = await getDataByKey(STORE_STUDENTS, roll);
            if (!student) {
                resultDiv.innerHTML = `<span style="color:var(--danger-color)">❌ Invalid Roll Number: ${roll}</span>`;
                return;
            }

            const attendanceRecords = await loadAttendance();
            if (attendanceRecords.find(r => r.roll === roll && r.date === today)) {
                resultDiv.innerHTML = `<span style="color:var(--danger-color)">❌ Attendance already marked for ${student.name}.</span>`;
            } else {
                const newRecord = { roll, name: student.name, class: student.class || 'N/A', ts: Date.now(), date: today };
                await saveAttendanceRecord(newRecord);
                resultDiv.innerHTML = `<span style="color:var(--secondary-color)">✅ Attendance marked for ${student.name}.</span>`;
                speak(`Attendance marked for ${student.name}`);
            }
            await showStudentHistory(roll, resultDivId === 'scanResult' ? 'scanHistory' : 'manualHistory');
        } catch (e) {
            console.error("DB Error during scan:", e);
            resultDiv.innerHTML = `<span style="color:var(--danger-color)">❌ Database error processing ${roll}.</span>`;
        }
    }

    document.getElementById('markManual').addEventListener('click', () => {
        const roll = document.getElementById('manualRoll').value.trim();
        handleScan(roll, 'manualResult');
        document.getElementById('manualRoll').value = '';
    });

    // ---------- UI Rendering Functions ----------
    const speak = (text) => {
        try {
            if ('speechSynthesis' in window) {
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = "en-IN";
                window.speechSynthesis.speak(utter);
            }
        } catch (e) { console.error('Speech error', e); }
    };

    async function showStudentHistory(roll, ulId) {
        const ul = document.getElementById(ulId);
        const allRecs = await loadAttendance();
        const recs = allRecs.filter(r => r.roll === roll).sort((a, b) => b.ts - a.ts).slice(0, 10);
        ul.innerHTML = recs.length === 0
            ? '<li>No attendance records found for this roll.</li>'
            : recs.map(r => `<li>${r.date} — ${r.roll} — ${r.name}</li>`).join('');
    }

    async function renderStudents() {
        const ul = document.getElementById('stuList');
        const students = await loadStudents();
        students.sort((a, b) => a.roll.localeCompare(b.roll, undefined, { numeric: true }));
        ul.innerHTML = students.map(s => `<li>Roll: ${s.roll} — Name: ${s.name} — Class: ${s.class || 'N/A'}</li>`).join('');
    }

    async function renderAttendance() {
        const ul = document.getElementById('attList');
        const records = await loadAttendance();
        records.sort((a, b) => b.ts - a.ts);
        ul.innerHTML = records.slice(0, 100).map(r => {
            const ts = new Date(r.ts).toLocaleTimeString();
            return `<li>${r.date} ${ts} — Roll: ${r.roll} — Name: ${r.name} — Class: ${r.class || 'N/A'}</li>`;
        }).join('');
    }

    // ---------- CSV & DB Utilities ----------
    const escapeCsv = (val) => {
        if (val == null) return '';
        let str = String(val);
        return str.includes(',') || str.includes('"') || str.includes('\n') ? `"${str.replace(/"/g, '""')}"` : str;
    };
    
    function downloadFile(data, filename, type) {
        const blob = new Blob([data], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    document.getElementById('exportStudents').addEventListener('click', async () => {
        const students = await loadStudents();
        let csv = "roll,name,class\n";
        students.forEach(s => { csv += `${escapeCsv(s.roll)},${escapeCsv(s.name)},${escapeCsv(s.class)}\n`; });
        downloadFile(csv, "students.csv", "text/csv;charset=utf-8;");
    });
    
    document.getElementById('backupDB').addEventListener('click', async () => {
        try {
            const backupData = JSON.stringify({
                students: await loadStudents(),
                attendance: await loadAttendance(),
                workingDays: loadWorkingDays()
            }, null, 2);
            downloadFile(backupData, `attendance_db_backup_${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
        } catch (e) {
            console.error("Backup failed:", e);
            alert('Database backup failed.');
        }
    });

    document.getElementById('importCSV').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            const text = ev.target.result;
            const lines = (text || '').trim().split(/\r?\n/);
            const existingStudents = await loadStudents();
            let importedCount = 0;
            
            // ** FIXED ** change 'const' to 'let' for the field variable
            const parseCsvLine = (line) => {
                const result = [];
                let field = ''; 
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"' && inQuotes && line[i + 1] === '"') {
                        field += '"'; i++;
                    } else if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(field.trim()); field = '';
                    } else {
                        field += char;
                    }
                }
                result.push(field.trim());
                return result.map(s => s.replace(/^"|"$/g, ''));
            };

            for (let i = 1; i < lines.length; i++) { // Start from 1 to skip header
                if (!lines[i].trim()) continue;
                const cols = parseCsvLine(lines[i]);
                const [roll, name, cls] = [cols[0], cols[1], cols[2] || 'N/A'];
                if (roll && name && !existingStudents.find(s => s.roll === roll)) {
                    await saveStudent({ roll, name, class: cls });
                    importedCount++;
                }
            }
            await renderStudents();
            alert(`Successfully imported ${importedCount} new students.`);
            e.target.value = ''; // Clear file input
        };
        reader.readAsText(file);
    });

    // ---------- Reports ----------
    async function populateMonthSelector() {
        const monthSelect = document.getElementById('monthSelect');
        const recs = await loadAttendance();
        const monthSet = new Set(recs.map(r => r.date.substring(0, 7)));
        const sortedMonths = Array.from(monthSet).sort().reverse();
        
        monthSelect.innerHTML = '<option value="all">All Months</option>' + sortedMonths.map(month => {
            const [year, monthNum] = month.split('-');
            const monthName = new Date(year, monthNum - 1, 1).toLocaleString('default', { month: 'long' });
            return `<option value="${month}">${monthName} ${year}</option>`;
        }).join('');
    }

    async function calculateReportData(selectedMonth) {
        let attendance = await loadAttendance();
        if (selectedMonth !== 'all') {
            attendance = attendance.filter(r => r.date.startsWith(selectedMonth));
        }
        
        const students = await loadStudents();
        const workingDays = parseInt(document.getElementById('workingDays').value) || 0;
        saveWorkingDays(workingDays);

        const studentsMap = new Map(students.map(s => [s.roll, s]));
        const studentReport = new Map();
        
        attendance.forEach(r => {
            const studentInfo = studentsMap.get(r.roll) || { name: r.name, class: r.class || 'N/A' };
            const monthKey = r.date.substring(0, 7);
            const stuKey = `${r.roll}|${monthKey}`;
            
            if (!studentReport.has(stuKey)) {
                studentReport.set(stuKey, { ...studentInfo, month: monthKey, days: new Set() });
            }
            studentReport.get(stuKey).days.add(r.date);
        });

        const studentRows = Array.from(studentReport.values()).map(item => {
            const [year, month] = item.month.split('-').map(Number);
            const totalDays = workingDays === 0 ? new Date(year, month, 0).getDate() : workingDays;
            const attended = item.days.size;
            const perc = totalDays > 0 ? ((attended / totalDays) * 100).toFixed(1) : '0.0';
            return { ...item, attended, totalDays, perc };
        });

        const classReport = new Map();
        studentRows.forEach(r => {
            const key = `${r.class}|${r.month}`;
            if (!classReport.has(key)) {
                classReport.set(key, { class: r.class, month: r.month, totalStudents: 0, totalDays: r.totalDays, totalAttendance: 0, uniqueStudents: new Set() });
            }
            const report = classReport.get(key);
            if (!report.uniqueStudents.has(r.roll)) {
                report.totalStudents++;
                report.uniqueStudents.add(r.roll);
            }
            report.totalAttendance += r.attended;
        });

        const classRows = Array.from(classReport.values()).map(c => {
            const maxPossible = c.totalStudents * c.totalDays;
            const perc = maxPossible > 0 ? ((c.totalAttendance / maxPossible) * 100).toFixed(1) : '0.0';
            return { ...c, perc };
        });

        return { studentRows, classRows };
    }

    async function handleGenerateReport() {
        const selectedMonth = document.getElementById('monthSelect').value;
        const { studentRows, classRows } = await calculateReportData(selectedMonth);

        const sTbody = document.querySelector('#reportTable tbody');
        sTbody.innerHTML = studentRows.length > 0
            ? studentRows.map(r => `<tr><td>${r.roll}</td><td>${r.name}</td><td>${r.class}</td><td>${r.month}</td><td>${r.attended}</td><td>${r.totalDays}</td><td>${r.perc}%</td></tr>`).join('')
            : '<tr><td colspan="7">No data for selected period.</td></tr>';

        const cTbody = document.querySelector('#classReportTable tbody');
        cTbody.innerHTML = classRows.length > 0
            ? classRows.map(c => `<tr><td>${c.class}</td><td>${c.month}</td><td>${c.totalStudents}</td><td>${c.totalDays}</td><td>${c.totalAttendance}</td><td>${c.perc}%</td></tr>`).join('')
            : '<tr><td colspan="6">No data for selected period.</td></tr>';
    }

    document.getElementById('genReport').addEventListener('click', handleGenerateReport);

    document.getElementById('exportStudentReport').addEventListener('click', async () => {
        const selectedMonth = document.getElementById('monthSelect').value;
        const { studentRows } = await calculateReportData(selectedMonth);
        let csv = "roll,name,class,month,attended,totalDays,percentage\n";
        studentRows.forEach(r => { csv += `${escapeCsv(r.roll)},${escapeCsv(r.name)},${escapeCsv(r.class)},${r.month},${r.attended},${r.totalDays},${r.perc}%\n`; });
        downloadFile(csv, "student_report.csv", "text/csv;charset=utf-8;");
    });
    
    document.getElementById('exportClassReport').addEventListener('click', async () => {
        const selectedMonth = document.getElementById('monthSelect').value;
        const { classRows } = await calculateReportData(selectedMonth);
        let csv = "class,month,totalStudents,totalDays,totalAttendance,percentage\n";
        classRows.forEach(c => { csv += `${escapeCsv(c.class)},${c.month},${c.totalStudents},${c.totalDays},${c.totalAttendance},${c.perc}%\n`; });
        downloadFile(csv, "class_report.csv", "text/csv;charset=utf-8;");
    });

    // Initialize first tab
    document.querySelector('nav button').click();
});
</script>
</body>
</html>
