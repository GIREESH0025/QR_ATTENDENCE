<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Attendance System</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f4f6f8; color:#333; }
  nav button { margin: 5px; padding: 10px 16px; font-size: 16px; border:none; border-radius:6px; cursor:pointer; }
  .tab { display: none; margin-top: 20px; }
  .active { display: block; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; background:#fff; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #eee; }
  video { width: 100%; max-height: 300px; background: #000; margin-top: 10px; }
  input, select { padding: 6px; margin: 5px; }
</style>
</head>
<body>
<h1>üìå QR Attendance System</h1>

<nav>
  <button onclick="openTab('scanTab')">üì∑ Scan</button>
  <button onclick="openTab('reportTab')">üìä Report</button>
</nav>

<!-- Scan Tab -->
<div id="scanTab" class="tab active">
  <h2>Scan Attendance</h2>
  <video id="preview" autoplay></video><br>
  <button id="startScan">‚ñ∂Ô∏è Start Scan</button>
  <button id="stopScan">‚èπ Stop Scan</button>
  <p id="scanResult">Not scanning...</p>
</div>

<!-- Report Tab -->
<div id="reportTab" class="tab">
  <h2>Generate Report</h2>
  <label>Month: <input type="month" id="reportMonth"></label>
  <label>Working Days: <input type="number" id="workingDays" min="1"></label>
  <button id="genReport">Generate</button>

  <h3>Student Report</h3>
  <table id="reportTable">
    <thead>
      <tr>
        <th>Roll</th><th>Name</th><th>Class</th><th>Month</th>
        <th>Attended</th><th>Working Days</th><th>%</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Class Report</h3>
  <table id="classReportTable">
    <thead>
      <tr>
        <th>Class</th><th>Month</th><th>Total Students</th>
        <th>Working Days</th><th>Total Attendance</th><th>Overall %</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
/* ---------- Tab Switching ---------- */
function openTab(tabId){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
}

/* ---------- IndexedDB Setup ---------- */
let db;
const request=indexedDB.open("AttendanceDB",1);
request.onupgradeneeded=e=>{
  db=e.target.result;
  const store=db.createObjectStore("attendance",{keyPath:"id",autoIncrement:true});
  store.createIndex("roll","roll",{unique:false});
  store.createIndex("date","date",{unique:false});
};
request.onsuccess=e=>{ db=e.target.result; };
request.onerror=e=>{ console.error("DB error",e); };

/* ---------- Save Attendance ---------- */
function markAttendance(roll,name,className){
  const date=new Date().toISOString().slice(0,10);
  const tx=db.transaction("attendance","readwrite");
  const store=tx.objectStore("attendance");
  const record={roll,name,class:className,date};
  store.add(record);

  // Voice feedback
  const msg=new SpeechSynthesisUtterance(`Attendance marked for ${name}, roll number ${roll}`);
  speechSynthesis.speak(msg);
}

/* ---------- QR Scan ---------- */
let codeReader,activeStream,lastScanned="";
document.getElementById('startScan').addEventListener('click',async()=>{
  if(!codeReader) codeReader=new ZXing.BrowserQRCodeReader();
  const preview=document.getElementById('preview');
  try{
    if(activeStream) activeStream.getTracks().forEach(t=>t.stop());
    activeStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    preview.srcObject=activeStream;
    preview.setAttribute("playsinline",true);
    await preview.play();

    codeReader.decodeFromVideoDevice(null,preview,(result,err)=>{
      if(result){
        const payload=result.getText();
        if(payload!==lastScanned){
          lastScanned=payload;
          document.getElementById('scanResult').textContent="Scanned: "+payload;
          const [roll,name,className]=payload.split(",");
          markAttendance(roll,name,className);
          setTimeout(()=>{ lastScanned=""; },2000);
        }
      }
    });
  }catch(e){ console.error("Camera error:",e); alert("Camera access failed"); }
});

document.getElementById('stopScan').addEventListener('click',()=>{
  if(activeStream){
    activeStream.getTracks().forEach(t=>t.stop());
    activeStream=null;
    document.getElementById('scanResult').textContent="Scan stopped.";
  }
});

/* ---------- Generate Report ---------- */
function calculateMonthlyReport(month,workingDays){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction("attendance","readonly");
    const store=tx.objectStore("attendance");
    const req=store.getAll();
    req.onsuccess=()=>{
      const data=req.result.filter(r=>r.date.startsWith(month));
      const students={},classReport={};

      data.forEach(r=>{
        const key=r.roll+"|"+r.class+"|"+month;
        if(!students[key]) students[key]={roll:r.roll,name:r.name,class:r.class,attended:0};
        students[key].attended+=1;
      });

      const studentRows=[];
      for(const k in students){
        const s=students[k];
        const perc=((s.attended/workingDays)*100).toFixed(1);
        studentRows.push({roll:s.roll,name:s.name,class:s.class,month,attended:s.attended,workingDays,perc});
      }

      studentRows.forEach(r=>{
        const key=`${r.class}|${month}`;
        if(!classReport[key]) classReport[key]={class:r.class,month,totalStudents:0,totalAttendance:0};
        classReport[key].totalStudents+=1;
        classReport[key].totalAttendance+=r.attended;
      });

      const classRows=[];
      for(const k in classReport){
        const c=classReport[k];
        const maxPossible=c.totalStudents*workingDays;
        const perc=((c.totalAttendance/maxPossible)*100).toFixed(1);
        classRows.push({class:c.class,month,totalStudents:c.totalStudents,workingDays,totalAttendance:c.totalAttendance,perc});
      }

      resolve({studentRows,classRows});
    };
    req.onerror=e=>reject(e);
  });
}

document.getElementById('genReport').addEventListener('click',async()=>{
  const month=document.getElementById('reportMonth').value;
  const workingDays=parseInt(document.getElementById('workingDays').value);
  if(!month||!workingDays){ alert("Enter both month and working days"); return; }

  const {studentRows,classRows}=await calculateMonthlyReport(month,workingDays);

  const tbody=document.querySelector('#reportTable tbody');
  tbody.innerHTML="";
  studentRows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.roll}</td><td>${r.name}</td><td>${r.class}</td><td>${r.month}</td>
      <td>${r.attended}</td><td>${r.workingDays}</td><td>${r.perc}%</td>`;
    tbody.appendChild(tr);
  });

  const tbody2=document.querySelector('#classReportTable tbody');
  tbody2.innerHTML="";
  classRows.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.class}</td><td>${c.month}</td><td>${c.totalStudents}</td>
      <td>${c.workingDays}</td><td>${c.totalAttendance}</td><td>${c.perc}%</td>`;
    tbody2.appendChild(tr);
  });
});
</script>
</body>
</html>
