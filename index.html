<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Attendance System</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f6f8; color:#333; }
h1,h2,h3{text-align:center;color:#222;}
h1{margin-top:20px;font-size:2rem;}
h2{margin-top:10px;font-size:1.5rem;}
h3{margin-top:20px;font-size:1.2rem;}
nav{display:flex;justify-content:center;flex-wrap:wrap;margin:20px 0;gap:8px;}
nav button{padding:10px 18px;border:none;border-radius:8px;background:#007bff;color:#fff;font-size:14px;cursor:pointer;transition:background 0.3s,transform 0.2s;}
nav button:hover{background:#0056b3;transform:translateY(-2px);}
.tab{display:none;max-width:900px;margin:0 auto 40px;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.active{display:block;}
label{display:block;margin:10px 0 5px;font-weight:600;}
input,select{width:100%; max-width:300px; padding:8px 10px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;}
#qrCanvas{display:block;margin:15px auto;border:2px solid #007bff;border-radius:8px;}
#downloadBtn{display:inline-block;margin:10px auto;padding:8px 12px;background:#28a745;color:#fff;border-radius:6px;text-decoration:none;font-weight:600;transition:background 0.3s;}
#downloadBtn:hover{background:#218838;}
#genStatus{text-align:center;margin-top:10px;font-size:14px;}
#preview{display:block;margin:0 auto 10px;border-radius:8px;}
#scanControls{text-align:center;margin-bottom:10px;}
#scanControls button{padding:8px 14px;margin:5px;border-radius:6px;border:none;background:#007bff;color:#fff;font-weight:600;}
#scanResult{text-align:center;font-weight:600;margin:10px 0;font-size:15px;}
#scanHistory{max-width:500px;margin:0 auto;list-style:none;padding:0;}
#scanHistory li{background:#f1f3f5;margin:4px 0;padding:6px 12px;border-radius:6px;font-size:14px;}
table{width:100%;max-width:900px;margin:10px auto 20px;border-collapse:collapse;box-shadow:0 2px 8px rgba(0,0,0,0.05);border-radius:8px;overflow:hidden;}
th,td{padding:10px 12px;text-align:center;}
th{background:#007bff;color:#fff;}
tbody tr:nth-child(even){background:#f8f9fa;}
tbody tr:hover{background:#d1ecf1;cursor:pointer;}
button[id^="export"],#genReport,#markManual{display:inline-block;margin:5px;padding:8px 14px;border:none;border-radius:6px;background:#17a2b8;color:#fff;font-weight:600;transition:background 0.3s;}
button[id^="export"]:hover,#genReport:hover,#markManual:hover{background:#138496;}
@media(max-width:600px){nav{flex-direction:column;align-items:center;}input,button,select{width:90%;max-width:300px;}table,canvas{width:90%;}}
</style>
</head>
<body>
<h1>QR Attendance System</h1>

<nav>
  <button data-tab="gen">Generate QR</button>
  <button data-tab="scan">Scan QR</button>
  <button data-tab="manual">Manual Attendance</button>
  <button data-tab="students">Students</button>
  <button data-tab="attendance">Attendance</button>
  <button data-tab="reports">Reports</button>
</nav>

<!-- Generate QR -->
<div id="gen" class="tab">
<h2>Generate QR Code</h2>
<label>Roll: <input id="genRoll" type="text"></label>
<label>Name: <input id="genName" type="text"></label>
<label>Class: <input id="genClass" type="text"></label>
<button id="genBtn">Generate</button>
<canvas id="qrCanvas" width="450" height="450"></canvas>
<a id="downloadBtn" style="display:none">Download QR</a>
<div id="genStatus"></div>
</div>

<!-- Scan QR -->
<div id="scan" class="tab">
<h2>Scan QR Code</h2>
<video id="preview" width="300" height="200" style="border:1px solid #ccc"></video>
<div id="scanControls">
  <button id="startScan">Start Scan</button>
  <button id="stopScan">Stop Scan</button>
</div>
<div id="scanResult"></div>
<h3>Attendance History for Scanned Student</h3>
<ul id="scanHistory"></ul>
</div>

<!-- Manual Attendance -->
<div id="manual" class="tab">
<h2>Manual Attendance (Backup)</h2>
<label>Select Student:
  <select id="manualStudent"></select>
</label>
<label>Select Date:
  <input type="date" id="manualDate">
</label>
<button id="markManual">Mark Present</button>
<div id="manualStatus"></div>
</div>

<!-- Students -->
<div id="students" class="tab">
<h2>Students</h2>
<input type="file" id="importCSV" accept=".csv">
<button id="exportStudents">Export Students CSV</button>
<ul id="stuList"></ul>
</div>

<!-- Attendance -->
<div id="attendance" class="tab">
<h2>Attendance Records</h2>
<button id="exportRawAttendance">Export Raw Attendance CSV</button>
<button id="exportStudentReport">Export Student Report CSV</button>
<button id="exportClassReport">Export Class Report CSV</button>
<ul id="attList"></ul>
</div>

<!-- Reports -->
<div id="reports" class="tab">
<h2>Monthly Attendance Report</h2>
<label>Enter Working Days for Percentage Calculation: <input type="number" id="workingDays" placeholder="e.g. 22"></label>
<button id="genReport">Generate Report</button>

<h3>Student-wise Report</h3>
<table id="reportTable">
<thead>
<tr>
<th>Roll</th><th>Name</th><th>Class</th><th>Month</th>
<th>Days Attended</th><th>Total Days</th><th>%</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h3>Class-wise Report</h3>
<table id="classReportTable">
<thead>
<tr>
<th>Class</th><th>Month</th><th>Total Students</th>
<th>Total Days</th><th>Total Attendance</th><th>%</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
// ---------- Storage ----------
function loadStudents(){ try { return JSON.parse(localStorage.getItem('students')||'[]'); } catch(e){ return []; } }
function saveStudents(data){ localStorage.setItem('students',JSON.stringify(data)); }
function loadAttendance(){ try { return JSON.parse(localStorage.getItem('attendance')||'[]'); } catch(e){ return []; } }
function saveAttendance(data){ localStorage.setItem('attendance',JSON.stringify(data)); }

// ---------- Tabs ----------
document.querySelectorAll('nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
    if(btn.dataset.tab==='students') renderStudents();
    if(btn.dataset.tab==='attendance') renderAttendance();
    if(btn.dataset.tab==='manual') renderManualDropdown();
  });
});
document.querySelector('nav button').click(); // default

// ---------- QR Generation ----------
const qr = new QRious({ element: document.getElementById('qrCanvas'), size: 250 });
document.getElementById('genBtn').addEventListener('click',()=>{
  const roll=document.getElementById('genRoll').value.trim();
  const name=document.getElementById('genName').value.trim();
  const cls=document.getElementById('genClass').value.trim();
  if(!roll||!name){ alert("Enter roll and name"); return; }
  const data=JSON.stringify({roll,name,class:cls});
  qr.value=data;
  const dl=document.getElementById('downloadBtn');
  dl.href=qr.toDataURL(); dl.download=`${roll}.png`; dl.style.display='block';
  document.getElementById('genStatus').innerHTML=`QR Generated for ${name}`;
  let st=loadStudents(); if(!st.find(s=>s.roll===roll)){ st.push({roll,name,class:cls}); saveStudents(st); }
});

// ---------- QR Scanning ----------
let codeReader=null;
document.getElementById('startScan').addEventListener('click',()=>{
  codeReader=new ZXing.BrowserQRCodeReader();
  codeReader.decodeFromVideoDevice(null,'preview',(res,err)=>{
    if(res){
      try{
        const d=JSON.parse(res.text);
        markAttendance(d.roll,d.name,d.class,false);
      }catch(e){ document.getElementById('scanResult').textContent="Invalid QR"; }
    }
  });
});
document.getElementById('stopScan').addEventListener('click',()=>{ if(codeReader){ codeReader.reset(); document.getElementById('scanResult').textContent="Scanner stopped"; }});

// ---------- Attendance Marking ----------
function markAttendance(roll,name,cls,manual){
  const recs=loadAttendance();
  const today=new Date().toISOString().slice(0,10);
  if(recs.find(r=>r.roll===roll&&r.date===today)){
    document.getElementById('scanResult').innerHTML=`${roll} already marked today`;
    return;
  }
  recs.unshift({roll,name,class:cls,date:today,ts:Date.now(),manual});
  saveAttendance(recs);
  document.getElementById('scanResult').innerHTML=`✔ ${roll} marked present (${manual?"Manual":"QR"})`;
  renderScanHistory(roll);
}

// ---------- Scan History ----------
function renderScanHistory(roll){
  const list=document.getElementById('scanHistory'); list.innerHTML='';
  loadAttendance().filter(r=>r.roll===roll).forEach(r=>{
    const li=document.createElement('li'); li.textContent=`${r.date} - ${r.manual?"Manual":"QR"}`; list.appendChild(li);
  });
}

// ---------- Manual Attendance ----------
function renderManualDropdown(){
  const sel=document.getElementById('manualStudent'); sel.innerHTML='';
  loadStudents().forEach(s=>{
    const opt=document.createElement('option'); opt.value=s.roll; opt.textContent=`${s.roll} — ${s.name} — ${s.class||'N/A'}`; sel.appendChild(opt);
  });
  document.getElementById('manualDate').value=new Date().toISOString().slice(0,10);
}
document.getElementById('markManual').addEventListener('click',()=>{
  const roll=document.getElementById('manualStudent').value;
  const date=document.getElementById('manualDate').value;
  if(!roll||!date){ alert("Select student and date"); return; }
  const stu=loadStudents().find(s=>s.roll===roll);
  const recs=loadAttendance();
  if(recs.find(r=>r.roll===roll && r.date===date)){
    document.getElementById('manualStatus').innerHTML=`<small style="color:red">❌ Already marked</small>`; return;
  }
  recs.unshift({roll:stu.roll,name:stu.name,class:stu.class,date:date,ts:Date.now(),manual:true});
  saveAttendance(recs);
  document.getElementById('manualStatus').innerHTML=`<small style="color:green">✔ Marked manually: ${stu.roll}</small>`;
});

// ---------- Students ----------
function renderStudents(){
  const ul=document.getElementById('stuList'); ul.innerHTML='';
  loadStudents().forEach(s=>{ const li=document.createElement('li'); li.textContent=`${s.roll} - ${s.name} (${s.class||"N/A"})`; ul.appendChild(li); });
}

// ---------- Attendance ----------
function renderAttendance(){
  const ul=document.getElementById('attList'); ul.innerHTML='';
  loadAttendance().forEach(r=>{
    const li=document.createElement('li'); li.textContent=`${r.date} - ${r.roll} - ${r.name} (${r.manual?"Manual":"QR"})`; ul.appendChild(li);
  });
}

// ---------- Reports ----------
document.getElementById('genReport').addEventListener('click',()=>{
  const days=parseInt(document.getElementById('workingDays').value)||0;
  const tbody=document.querySelector('#reportTable tbody'); tbody.innerHTML='';
  const classTbody=document.querySelector('#classReportTable tbody'); classTbody.innerHTML='';
  const recs=loadAttendance();
  const groups={};
  recs.forEach(r=>{
    const m=r.date.slice(0,7);
    const key=r.roll+"_"+m;
    if(!groups[key]) groups[key]={roll:r.roll,name:r.name,class:r.class,month:m,count:0};
    groups[key].count++;
  });
  Object.values(groups).forEach(g=>{
    const tr=document.createElement('tr');
    const perc=days?(g.count/days*100).toFixed(1):"-";
    tr.innerHTML=`<td>${g.roll}</td><td>${g.name}</td><td>${g.class}</td><td>${g.month}</td><td>${g.count}</td><td>${days||"-"}</td><td>${perc}</td>`;
    tbody.appendChild(tr);
  });
  // Class wise
  const cgroups={};
  Object.values(groups).forEach(g=>{
    const k=g.class+"_"+g.month;
    if(!cgroups[k]) cgroups[k]={class:g.class,month:g.month,students:new Set(),total:0};
    cgroups[k].students.add(g.roll); cgroups[k].total+=g.count;
  });
  Object.values(cgroups).forEach(c=>{
    const tr=document.createElement('tr');
    const perc=days?(c.total/(c.students.size*days)*100).toFixed(1):"-";
    tr.innerHTML=`<td>${c.class}</td><td>${c.month}</td><td>${c.students.size}</td><td>${days||"-"}</td><td>${c.total}</td><td>${perc}</td>`;
    classTbody.appendChild(tr);
  });
});
</script>
</body>
</html>
